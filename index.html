<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title id="document-title">ミステリーボックス履歴</title>
  <link rel="icon" href="data:,">
  <style type="text/css">
body { margin-left: 1em; font-family: sans-serif }
h2 { font-size: 100%; font-weight: bold }
h3 { background: #ccc; padding-left: 0.5em; margin-bottom: 0.1em; margin-top: 0.2em }
table { margin-top: 0.1em }
td { padding: 0 }
img { display: block }
.head-ratio { font-size: 80%; font-weight: normal; }
.value { font-size: 70%; text-align: center }
#setup { width: 90%; border: 1px solid #111; position: absolute; background: #fff; padding: 1em; }
.visible { display: float }
.hidden { display: none }
  </style>
</head>
<body>
<script>
// id: [name, rarity: 0: R, 1: SR, 2: SSR, kind: 0: item, 1: wepon, 2: doll]
const ENTRIES = {
  // items
  2: ["サルディスゴールド", 0, 0],
  25: ["作戦報告書", 0, 0],
  8301: ["解析図面", 0, 0],
  8328: ["拡張ストレージT1", 0, 0],
  8329: ["拡張ストレージT2", 0, 0],
  8330: ["拡張ストレージT3", 1, 0],
  9008: ["接続媒体III", 0, 0],
  9009: ["接続媒体IV", 1, 0],
  9010: ["接続媒体V", 2, 0],
  9011: ["接続媒体VI", 2, 0],
  300003: ["ノーマルメモリ", 0, 0],
  // dolls
  1021: ["ペリティア", 2, 2],
  // wepons
  11007: ["野兎", 1, 1],
  11014: [".50 Nemesis", 1, 1],
  11015: [".380 Curva", 1, 1],
  11021: ["Vepr-12", 1, 1],
  11023: ["OTs-14", 1, 1],
  11026: ["ペチェネグ-SP", 1, 1],
  11040: ["MP7H1", 1, 1],
};


window.addEventListener("load", function () {
  getElement("setup-button").addEventListener("click", () => { showElement("setup", true); });
  getElement("player-data-button").addEventListener("click", readFromPlayerData);
  getElement("data-set-button").addEventListener("click", readFromDataSet);
  const m = new UserDataManager();
  if (!m.hasData()) {
    showElement("setup", true);
  } else {
    loadData();
  }
});

function readFromPlayerData() {
  const s = getValue("player-data");
  try {
    const data = JSON.parse(s);
    readUserData(data.uid, data.token);
  } catch (e) {
    console.log(e);
  }
}

function readFromDataSet() {
  const uid = getValue("uid");
  const token = getValue("token");
  readUserData(uid, token);
}

function readUserData(uid, token) {
  console.log(uid);
  const m = new UserDataManager();
  m.store(uid, token);

  showElement("setup", false);
  showElement("error", false);
  loadData();
}

function showElement(id, visible) {
  if (visible || visible === undefined) {
    getElement(id).classList.remove('hidden');
  } else {
    getElement(id).classList.add('hidden');
  }
}

// type_id, 8: ミステリーボックス
class Fetcher {
  constructor(uid, token, type_id, entries, callback) {
    this.uid = uid;
    this.token = token;
    this.type_id = type_id;
    this.next_id = null;
    this.target = "https://gf2-gacha-record-jp.haoplay.com/list";
    this.entries = entries;
    this.callback = callback;
  }

  fetchNext = () => {
    const limit = 20;
    let data = `type_id=${this.type_id}&u=${this.uid}&limit=${limit}`;
    if (this.next_id !== null && this.next_id != "") {
      data += `&next=${this.next_id}`;
    }
    const headers = new Headers({
      "Authorization": this.token,
      "Accept": "application/json, text/plain, */*",
      "Content-Type": "application/x-www-form-urlencoded",
    });
    const options = {
      method: "POST",
      headers: headers,
      body: data,
    };
    const req = new Request(this.target, options);

    window
      .fetch(req)
      .then((response) => {
        if (!response.ok) {
          // todo, show error
          console.log("no response");
        } else {
          response.blob().then((blob) => {
            blob.text().then((s) => {
              this.parseResponse(s);
            });
          });
        }
      });
  }

  parseResponse = (s) => {
    const data = JSON.parse(s);
    if (data.code != 0 && data.message != "OK") {
      // uid or token is wrong
      setText("error", "uid または token が違います");
      showElement("error", true);
      showElement("setup", true);
      return;
    }
    this.next_id = data.data.next;

    for (let entry of data.data.list) {
      const id = entry.item;
      const v = ENTRIES[entry.item];
      if (v === undefined) {
        console.log("item entry not found", entry.item);
      }
      this.entries.push(entry);
    }
    if (this.next_id) {
      this.fetchNext();
    } else if (this.callback) {
      this.callback(this.entries);
    }
  }
}

function loadData() {
  const m = new UserDataManager();
  const data = m.read();

  const entries = [];
  const f = new Fetcher(data.uid, data.token, 8, entries, parseResult);
  f.fetchNext();
}

function parseResult(entries) {
  const rarities = [0, 0, 0]; // R, SR, SSR
  const count = entries.length;
  const picked = new Map();
  for (const entry of entries) {
    const item = entry.item;
    const value = picked.get(item);
    if (value !== undefined) {
      picked.set(item, value + 1);
    } else {
      picked.set(item, 1);
    }
  }

  picked.forEach((value, key) => {
    const entry = ENTRIES[key];
    setText(`${key}v`, value);
    setText(`${key}r`, roundRatio(value / count * 100) + "%");

    if (entry[2] == 2) {
      rarities[2] += value;
    } else if (entry[2] == 1) {
      rarities[1] += value;
    } else {
      rarities[0] += value;
    }
  });

  setText("count", count);
  setText("r-ratio", roundRatio(rarities[0] / count * 100) + "%");
  setText("sr-ratio", roundRatio(rarities[1] / count * 100) + "%");
  setText("ssr-ratio", roundRatio(rarities[2] / count * 100) + "%");
}

function roundRatio(r) {
  return r.toPrecision(2);
}

function getElement(id) {
  return document.getElementById(id);
}

function getText(id) {
  return document.getElementById(id).textContent;
}

function setText(id, s) {
  document.getElementById(id).textContent = s;
}

function getValue(id) {
  return document.getElementById(id).value;
}

class UserDataManager {
  constuctor() {
  }

  getDataName() {
    return "user-data";
  }

  hasData() {
    return localStorage.getItem(this.getDataName()) !== null;
  }

  read() {
    const s = localStorage.getItem(this.getDataName());
    const data = JSON.parse(s);
    return data;
  }

  store = (uid, token) => {
    const data = { uid: uid, token: token };
    localStorage.setItem(this.getDataName(), JSON.stringify(data));
  }
}

</script>
<div id="setup-button" style="position: absolute; border: 1px solid #888; left: 90%; font-size: 90%; color: #888">設定</div>
<div id="setup" class="hidden">
  <div><a href="https://github.com/df2gh/misterybox">使い方</a></div>
  <div class="hidden" id="error" style="color: #f00"></div>
  <table>
    <tr><td>プレイヤーデータから読み込み - <a href="https://exilium.moe/ja/import">読み込み方法</a></td></tr>
    <tr><td><input type="text" size="80" id="player-data"></td></tr>
    <tr><td><input type="button" value="読み込み" id="player-data-button"></td></tr>
  </table>
  <hr>
  <table>
    <tr><td>uid</td></tr>
    <tr><td><input type="text" size="80" id="uid"></td></tr>
    <tr><td>access_token</td></tr>
    <tr><td><input type="text" size="80" id="token"></td></tr>
    <tr><td><input type="button" value="読み込み" id="data-set-button"></td></tr>
  </table>
</div>
<div id="result">
  <h2>ミステリーボックス - <span id="count"></span> 回中</h2>
  <h3>SSR - <span id="ssr-ratio" class="head-ratio"></span></h3>
  <table id="ssr">
    <tr><td id="1021"><img src="imgs/1021.png" width="50" height="50"></td></tr>
    <tr><td id="1021v" class="value"></td></tr>
    <tr><td id="1021r" class="value"></td></tr>
  </table>
  <h3>SR - <span id="sr-ratio" class="head-ratio"></span></h3>
  <table id="sr">
    <tr>
      <td id="11007"><img src="imgs/11007.png" width="50" height="50"></td>
      <td id="11014"><img src="imgs/11014.png" width="50" height="50"></td>
      <td id="11015"><img src="imgs/11015.png" width="50" height="50"></td>
      <td id="11021"><img src="imgs/11021.png" width="50" height="50"></td>
      <td id="11023"><img src="imgs/11023.png" width="50" height="50"></td>
      <td id="11040"><img src="imgs/11040.png" width="50" height="50"></td>
      <td id="11026"><img src="imgs/11026.png" width="50" height="50"></td>
    </tr>
    <tr>
      <td id="11007v" class="value"></td>
      <td id="11014v" class="value"></td>
      <td id="11015v" class="value"></td>
      <td id="11021v" class="value"></td>
      <td id="11023v" class="value"></td>
      <td id="11040v" class="value"></td>
      <td id="11026v" class="value"></td>
    </tr>
    <tr>
      <td id="11007r" class="value"></td>
      <td id="11014r" class="value"></td>
      <td id="11015r" class="value"></td>
      <td id="11021r" class="value"></td>
      <td id="11023r" class="value"></td>
      <td id="11040r" class="value"></td>
      <td id="11026r" class="value"></td>
    </tr>
  </table>
  <h3>R - <span id="r-ratio" class="head-ratio"></span></h3>
  <table id="r">
    <tr>
      <td id="2"><img src="imgs/2.png" width="50" height="50"></td>
      <td id="25"><img src="imgs/25.png" width="50" height="50"></td>
      <td id="8301"><img src="imgs/8301.png" width="50" height="50"></td>
      <td id="8328"><img src="imgs/8328.png" width="50" height="50"></td>
      <td id="8329"><img src="imgs/8329.png" width="50" height="50"></td>
      <td id="8330"><img src="imgs/8330.png" width="50" height="50"></td>
      <td id="9008"><img src="imgs/9008.png" width="50" height="50"></td>
      <td id="9009"><img src="imgs/9009.png" width="50" height="50"></td>
      <td id="9010"><img src="imgs/9010.png" width="50" height="50"></td>
      <td id="9011"><img src="imgs/9011.png" width="50" height="50"></td>
      <td id="300003"><img src="imgs/300003.png" width="50" height="50"></td>
    </tr>
    <tr>
      <td id="2v" class="value"></td>
      <td id="25v" class="value"></td>
      <td id="8301v" class="value"></td>
      <td id="8328v" class="value"></td>
      <td id="8329v" class="value"></td>
      <td id="8330v" class="value"></td>
      <td id="9008v" class="value"></td>
      <td id="9009v" class="value"></td>
      <td id="9010v" class="value"></td>
      <td id="9011v" class="value"></td>
      <td id="300003v" class="value"></td>
    </tr>
    <tr>
      <td id="2r" class="value"></td>
      <td id="25r" class="value"></td>
      <td id="8301r" class="value"></td>
      <td id="8328r" class="value"></td>
      <td id="8329r" class="value"></td>
      <td id="8330r" class="value"></td>
      <td id="9008r" class="value"></td>
      <td id="9009r" class="value"></td>
      <td id="9010r" class="value"></td>
      <td id="9011r" class="value"></td>
      <td id="300003r" class="value"></td>
    </tr>
  </table>
</div>
</body>
</html>
